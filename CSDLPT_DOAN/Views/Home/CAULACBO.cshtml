@{
    // Thiết lập tiêu đề trang
    ViewData["Title"] = "Quản lý Câu Lạc Bộ";
    Layout = "_Layout"; // Sử dụng layout mặc định của dự án
}
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

</head>
<div class="container mx-auto px-4 py-6">
    <h2 class="text-2xl font-bold mb-6 text-center text-primary">Quản lý Câu Lạc Bộ</h2>

    <div class="row mb-4 align-items-center">
        <div class="col-md-6 order-md-1">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Nhập tên CLB hoặc Mã CLB để tìm kiếm...">
                <button class="btn btn-outline-primary" type="button" id="btnSearch">
                    <i class="bi bi-search"></i> Tìm kiếm
                </button>
            </div>
        </div>
        <div class="col-md-6 text-md-end text-start order-md-2 mt-3 mt-md-0">
            <button class="btn btn-primary" id="btnAddClub" data-bs-toggle="modal" data-bs-target="#modalAdd">
                <i class="bi bi-plus-circle"></i> Thêm Câu Lạc Bộ
            </button>
        </div>
    </div>
    <div class="overflow-x-auto shadow-lg rounded-lg">
        <table class="table table-striped table-hover align-middle mb-0 bg-white rounded-lg text-center">
            <thead class="bg-primary text-white">
                <tr>
                    <th>ID</th>
                    <th>Tên CLB</th>
                    <th>Khoa</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="clbTableBody">
                <tr>
                    <td colspan="4" class="text-center text-muted">Đang tải dữ liệu...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalAdd" tabindex="-1" aria-labelledby="modalAddLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalAddLabel">Thêm Câu Lạc Bộ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <form id="formAdd">
                    <div class="mb-3 d-none">
                        <label class="form-label">Mã CLB</label>
                        <input type="text" class="form-control" id="addMaClb" placeholder="Nhập mã CLB (Ví dụ: CLB09)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tên CLB</label>
                        <input type="text" class="form-control" id="addTenClb" placeholder="Nhập tên CLB" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã Khoa</label>
                        <input type="text" class="form-control" id="addTenKhoa" placeholder="Nhập mã Khoa (Ví dụ: K1)" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btnSubmitAdd" class="btn btn-primary">Thêm</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetail" tabindex="-1" aria-labelledby="modalDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalDetailLabel">Chi Tiết Câu Lạc Bộ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p><strong>Mã CLB:</strong> <span id="detailMaClb"></span></p>
                <p><strong>Tên CLB:</strong> <span id="detailTenClb"></span></p>
                <p><strong>Khoa:</strong> <span id="detailTenKhoa"></span></p>
                <p><strong>Row Guid:</strong> <span id="detailRowGuid"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdit" tabindex="-1" aria-labelledby="modalEditLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="modalEditLabel">Chỉnh Sửa Câu Lạc Bộ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <form id="formEdit">
                    <input type="hidden" id="editRowGuid">
                    <div class="mb-3">
                        <label class="form-label">Mã CLB</label>
                        <input type="text" class="form-control" id="editMaClb" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tên CLB</label>
                        <input type="text" class="form-control" id="editTenClb" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã Khoa</label>
                        <input type="text" class="form-control" id="editTenKhoa" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btnSubmitEdit" class="btn btn-warning text-white">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDelete" tabindex="-1" aria-labelledby="modalDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalDeleteLabel">Xác Nhận Xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa Câu Lạc Bộ <strong id="deleteTenClb"></strong> (<span id="deleteMaClb"></span>) không?</p>
                <input type="hidden" id="deleteTargetMaClb">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btnConfirmDelete" class="btn btn-danger">Xóa</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        const apiUrl = "http://localhost:5057/api/CauLacBo";
        const tbody = document.getElementById("clbTableBody");
        let clubData = []; 

        // 🟢 Hàm tìm CLB theo Mã CLB
        function findClubByMaClb(maClb) {
            return clubData.find(clb => clb.maClb === maClb);
        }

        // 🟡 Hàm hiển thị dữ liệu ra bảng (sử dụng dữ liệu đã lọc hoặc toàn bộ)
        function renderClubs(dataToRender) {
            if (!Array.isArray(dataToRender) || dataToRender.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Không tìm thấy Câu Lạc Bộ nào.</td></tr>`;
                return;
            }

            tbody.innerHTML = "";
            dataToRender.forEach(clb => {
                const maCLB = clb.maClb ?? 'N/A';
                const tenCLB = clb.tenClb ?? 'Tên CLB bị thiếu';
                const tenKhoa = clb.tenKhoa ?? 'Chưa gán';

                tbody.innerHTML += `
                                <tr>
                                    <td>${maCLB}</td>
                                    <td>${tenCLB}</td>
                                    <td>${tenKhoa}</td>
                                    <td>
                                        <button class="btn btn-info btn-sm text-white" title="Xem chi tiết" onclick="showDetailModal('${clb.maClb}')"><i class="bi bi-card-list"></i></button>
                                        <button class="btn btn-warning btn-sm text-white" title="Chỉnh sửa" onclick="showEditModal('${clb.maClb}')"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-danger btn-sm" title="Xóa" onclick="showDeleteModal('${clb.maClb}')"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                            `;
            });
        }

        async function loadClubs() {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Đang tải dữ liệu...</td></tr>`;
            clubData = []; 

            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Lỗi HTTP: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

                const data = await response.json();
                clubData = data;

                renderClubs(clubData); 

            } catch (err) {
                console.error("Lỗi khi tải CLB:", err);
                tbody.innerHTML = `<tr><td colspan="4" class="text-danger text-center">
                                            <strong>❌ Lỗi tải dữ liệu.</strong> Vui lòng kiểm tra API: ${err.message}
                                        </td></tr>`;
            }
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            if (!searchTerm) {
                renderClubs(clubData); 
                return;
            }

            const filteredClubs = clubData.filter(clb => {
                const maCLB = clb.maClb ? clb.maClb.toLowerCase() : '';
                const tenCLB = clb.tenClb ? clb.tenClb.toLowerCase() : '';
                return maCLB.includes(searchTerm) || tenCLB.includes(searchTerm);
            });

            renderClubs(filteredClubs); 
        }

       function showDetailModal(maClb) {
            const clb = findClubByMaClb(maClb);
            if (!clb) return alert("Không tìm thấy dữ liệu CLB này.");
            document.getElementById('detailMaClb').textContent = clb.maClb;
            document.getElementById('detailTenClb').textContent = clb.tenClb;
            document.getElementById('detailTenKhoa').textContent = clb.tenKhoa ?? 'N/A';
            document.getElementById('detailRowGuid').textContent = clb.rowguid ?? 'N/A';
            new bootstrap.Modal(document.getElementById('modalDetail')).show();
        }

        function showEditModal(maClb) {
            const clb = findClubByMaClb(maClb);
            if (!clb) return alert("Không tìm thấy dữ liệu CLB này.");
            document.getElementById('editMaClb').value = clb.maClb;
            document.getElementById('editTenClb').value = clb.tenClb;
            document.getElementById('editTenKhoa').value = clb.tenKhoa ?? '';
            document.getElementById('editRowGuid').value = clb.rowguid;
            new bootstrap.Modal(document.getElementById('modalEdit')).show();
        }

        function showDeleteModal(maClb) {
            const clb = findClubByMaClb(maClb);
            if (!clb) return alert("Không tìm thấy dữ liệu CLB này.");
            document.getElementById('deleteTenClb').textContent = clb.tenClb;
            document.getElementById('deleteMaClb').textContent = clb.maClb;
            document.getElementById('deleteTargetMaClb').value = clb.maClb;
            new bootstrap.Modal(document.getElementById('modalDelete')).show();
        }

        // ============================= 🚀 CHỨC NĂNG API (POST, PUT, DELETE) 🚀 =================

        async function handleAddSubmit() {
            const tenClb = document.getElementById('addTenClb').value;
            const tenKhoa = document.getElementById('addTenKhoa').value;

            if (!tenClb || !tenKhoa) {
                return alert('Vui lòng nhập đầy đủ Tên CLB và Mã Khoa.');
            }

            const newClb = { tenClb, tenKhoa };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newClb)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Lỗi khi Thêm CLB: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

                bootstrap.Modal.getInstance(document.getElementById('modalAdd')).hide();
                document.getElementById('formAdd').reset();

                alert('Thêm Câu Lạc Bộ thành công! (ID được tạo tự động)');
                loadClubs(); // Tải lại toàn bộ danh sách

            } catch (err) {
                console.error("Lỗi khi thêm CLB:", err);
                alert(`Thêm thất bại. Lỗi: ${err.message}`);
            }
        }

        // 2. CHỨC NĂNG CHỈNH SỬA (PUT)
        async function handleEditSubmit() {
            const maClb = document.getElementById('editMaClb').value;
            const tenClb = document.getElementById('editTenClb').value;
            const tenKhoa = document.getElementById('editTenKhoa').value;
            const rowguid = document.getElementById('editRowGuid').value;

            if (!tenClb || !tenKhoa) {
                return alert('Vui lòng nhập đầy đủ Tên CLB và Mã Khoa.');
            }

            const updatedClb = { maClb, tenClb, tenKhoa, rowguid };
            const editUrl = `${apiUrl}/${maClb}`;

            try {
                const response = await fetch(editUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedClb)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Lỗi khi Chỉnh sửa CLB: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

                bootstrap.Modal.getInstance(document.getElementById('modalEdit')).hide();

                alert(`Chỉnh sửa CLB ${maClb} thành công!`);
                loadClubs();

            } catch (err) {
                console.error("Lỗi khi chỉnh sửa CLB:", err);
                alert(`Chỉnh sửa thất bại. Lỗi: ${err.message}`);
            }
        }

        // 3. CHỨC NĂNG XÓA (DELETE)
        async function handleDeleteConfirm() {
            const maClb = document.getElementById('deleteTargetMaClb').value;
            const deleteUrl = `${apiUrl}/${maClb}`;

            try {
                const response = await fetch(deleteUrl, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Lỗi khi Xóa CLB: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

                bootstrap.Modal.getInstance(document.getElementById('modalDelete')).hide();

                alert(`Xóa CLB ${maClb} thành công!`);
                loadClubs();

            } catch (err) {
                console.error("Lỗi khi xóa CLB:", err);
                alert(`Xóa thất bại. Lỗi: ${err.message}`);
            }
        }


        function fixModalA11y(modalId, elementToFocus) {
            const modalElement = document.getElementById(modalId);
            modalElement.addEventListener('hidden.bs.modal', function () {
                elementToFocus.focus();
            });
        }

       document.addEventListener("DOMContentLoaded", () => {
            loadClubs();

            // Gắn sự kiện cho các nút Submit
            document.getElementById('btnSubmitAdd').addEventListener('click', handleAddSubmit);
            document.getElementById('btnSubmitEdit').addEventListener('click', handleEditSubmit);
            document.getElementById('btnConfirmDelete').addEventListener('click', handleDeleteConfirm);

            // Gắn sự kiện cho Tìm kiếm
            document.getElementById('btnSearch').addEventListener('click', handleSearch);
            document.getElementById('searchInput').addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    handleSearch();
                } else {
                    handleSearch();
                }
            });

            const btnAddClub = document.getElementById('btnAddClub');
            fixModalA11y('modalAdd', btnAddClub);
            fixModalA11y('modalDetail', btnAddClub);
            fixModalA11y('modalEdit', btnAddClub);
            fixModalA11y('modalDelete', btnAddClub);
        });
    </script>
}